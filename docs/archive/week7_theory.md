# Week 7: FCM í‘¸ì‹œ ì•Œë¦¼ ì‹œìŠ¤í…œ - ì´ë¡ í¸

## ğŸ“š í•™ìŠµ ëª©í‘œ
Firebase Cloud Messaging(FCM)ì˜ ì›ë¦¬ë¥¼ ì´í•´í•˜ê³ , ì‹¤ì‹œê°„ í‘¸ì‹œ ì•Œë¦¼ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ëŠ” ë°©ë²•ì„ í•™ìŠµí•©ë‹ˆë‹¤. ë‹¤ì–‘í•œ ì•Œë¦¼ ì‹œë‚˜ë¦¬ì˜¤ì™€ ë°°í¬ ì¤€ë¹„ ê³¼ì •ì„ ë‹¤ë£¹ë‹ˆë‹¤.

## ğŸŒŸ í•µì‹¬ ê°œë…

### 1. í‘¸ì‹œ ì•Œë¦¼(Push Notification)ì´ë€?
**ì •ì˜**: ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ë””ë°”ì´ìŠ¤ë¡œ ì§ì ‘ ì „ì†¡í•˜ëŠ” ë©”ì‹œì§€

**Pull vs Push ë°©ì‹**:
```
Pull (í´ë¼ì´ì–¸íŠ¸ ìš”ì²­):
í´ë¼ì´ì–¸íŠ¸ â”€â”€ìš”ì²­â”€â”€> ì„œë²„
í´ë¼ì´ì–¸íŠ¸ <â”€â”€ì‘ë‹µâ”€â”€ ì„œë²„

Push (ì„œë²„ ì „ì†¡):
ì„œë²„ â”€â”€ì•Œë¦¼ ì „ì†¡â”€â”€> í´ë¼ì´ì–¸íŠ¸
(í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ì—†ì´ ìë™ ìˆ˜ì‹ )
```

### 2. FCM ì•„í‚¤í…ì²˜
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„              â”‚
â”‚         (Cloud Functions)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ ë©”ì‹œì§€ ì „ì†¡
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            FCM ì„œë²„                     â”‚
â”‚         (Google ì¸í”„ë¼)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚          â”‚
           â–¼          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Android  â”‚ â”‚   iOS    â”‚
    â”‚  Device  â”‚ â”‚  Device  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ë©”ì‹œì§€ ìœ í˜•

#### ì•Œë¦¼ ë©”ì‹œì§€ (Notification Message)
```javascript
{
  notification: {
    title: "ê±´ê°• ì•Œë¦¼",
    body: "ì˜¤ëŠ˜ ê±¸ìŒìˆ˜ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!",
    icon: "notification_icon",
    sound: "default"
  }
}
```
- ìë™ìœ¼ë¡œ ì‹œìŠ¤í…œ íŠ¸ë ˆì´ì— í‘œì‹œ
- ì•±ì´ ë°±ê·¸ë¼ìš´ë“œì¼ ë•Œ ìë™ ì²˜ë¦¬

#### ë°ì´í„° ë©”ì‹œì§€ (Data Message)
```javascript
{
  data: {
    type: "health_update",
    seniorId: "senior001",
    heartRate: "75",
    timestamp: "2024-01-20T10:30:00Z"
  }
}
```
- ì•±ì—ì„œ ì§ì ‘ ì²˜ë¦¬
- ë°±ê·¸ë¼ìš´ë“œì—ì„œë„ ì»¤ìŠ¤í…€ ë¡œì§ ì‹¤í–‰

#### í˜¼í•© ë©”ì‹œì§€
```javascript
{
  notification: { /* ... */ },
  data: { /* ... */ }
}
```

### 4. FCM í† í°
**ì •ì˜**: ê° ë””ë°”ì´ìŠ¤ë¥¼ ê³ ìœ í•˜ê²Œ ì‹ë³„í•˜ëŠ” ë¬¸ìì—´

```
í† í° ìƒëª…ì£¼ê¸°:
ìƒì„± â†’ ì €ì¥ â†’ ì‚¬ìš© â†’ ê°±ì‹  â†’ ë§Œë£Œ
 â”‚      â”‚      â”‚      â”‚      â”‚
 â”‚      â”‚      â”‚      â”‚      â””â”€ ì•± ì‚­ì œ/ì¬ì„¤ì¹˜
 â”‚      â”‚      â”‚      â””â”€ ì£¼ê¸°ì  ê°±ì‹ 
 â”‚      â”‚      â””â”€ ì•Œë¦¼ ì „ì†¡
 â”‚      â””â”€ ì„œë²„ì— ì €ì¥
 â””â”€ ì•± ì„¤ì¹˜/ì²« ì‹¤í–‰
```

## ğŸ”§ ì£¼ìš” ê¸°ëŠ¥

### ì•Œë¦¼ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ë¥˜

| ìœ í˜• | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| **ì¦‰ì‹œ ì•Œë¦¼** | ì¦‰ê° ì „ì†¡ | ê¸´ê¸‰ ê±´ê°• ìƒíƒœ |
| **ì˜ˆì•½ ì•Œë¦¼** | íŠ¹ì • ì‹œê°„ ì „ì†¡ | ì•½ ë³µìš© ì‹œê°„ |
| **ì¡°ê±´ë¶€ ì•Œë¦¼** | íŠ¹ì • ì¡°ê±´ ì¶©ì¡± ì‹œ | ì‹¬ë°•ìˆ˜ ì´ìƒ |
| **ë°°ì¹˜ ì•Œë¦¼** | ì—¬ëŸ¬ ì‚¬ìš©ì ë™ì‹œ | ì¼ì¼ ë¦¬í¬íŠ¸ |
| **í† í”½ ì•Œë¦¼** | êµ¬ë… ê¸°ë°˜ | ê±´ê°• íŒ êµ¬ë… |

### ì•Œë¦¼ ìš°ì„ ìˆœìœ„
```
HIGH (ë†’ìŒ):
â”œâ”€â”€ ì¦‰ì‹œ ì „ë‹¬
â”œâ”€â”€ ë””ë°”ì´ìŠ¤ ê¹¨ìš°ê¸°
â””â”€â”€ ì˜ˆ: ê¸´ê¸‰ ì•Œë¦¼

NORMAL (ë³´í†µ):
â”œâ”€â”€ ì¼ë°˜ ì „ë‹¬
â”œâ”€â”€ ë°°í„°ë¦¬ ìµœì í™”
â””â”€â”€ ì˜ˆ: ì¼ë°˜ ì•Œë¦¼

LOW (ë‚®ìŒ):
â”œâ”€â”€ ì§€ì—° ê°€ëŠ¥
â”œâ”€â”€ ë°°í„°ë¦¬ ì ˆì•½
â””â”€â”€ ì˜ˆ: í™ë³´ ë©”ì‹œì§€
```

## ğŸ’¡ ìš©ì–´ ì„¤ëª…

| ìš©ì–´ | ì„¤ëª… | ì˜ˆì‹œ |
|-----|------|------|
| **FCM Token** | ë””ë°”ì´ìŠ¤ ì‹ë³„ì | `fKBd3...xyz` |
| **Topic** | êµ¬ë… ì±„ë„ | `/topics/health_tips` |
| **Payload** | ë©”ì‹œì§€ ë‚´ìš© | JSON ë°ì´í„° |
| **TTL** | Time To Live | ë©”ì‹œì§€ ìœ íš¨ ê¸°ê°„ |
| **Priority** | ì „ì†¡ ìš°ì„ ìˆœìœ„ | high, normal |
| **Sound** | ì•Œë¦¼ ì†Œë¦¬ | default, custom |

## ğŸ“Š ì•Œë¦¼ ì²˜ë¦¬ í”Œë¡œìš°

### ê±´ê°• ì´ìƒ ì•Œë¦¼ í”Œë¡œìš°
```
1. ê±´ê°• ë°ì´í„° ìˆ˜ì§‘
       â†“
2. ì´ìƒ ìˆ˜ì¹˜ ê°ì§€
       â†“
3. ì•Œë¦¼ ëŒ€ìƒ ê²°ì •
       â†“
4. FCM ë©”ì‹œì§€ ìƒì„±
       â†“
5. í† í°ë³„ ì „ì†¡
       â†“
6. ë””ë°”ì´ìŠ¤ ìˆ˜ì‹ 
       â†“
7. ì‚¬ìš©ì í™•ì¸
       â†“
8. ì•Œë¦¼ ê¸°ë¡ ì €ì¥
```

### ìŠ¤ì¼€ì¤„ ì•Œë¦¼ ì‹œìŠ¤í…œ
```javascript
// Cloud Scheduler êµ¬ì¡°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scheduler   â”‚
â”‚  (cron job)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ íŠ¸ë¦¬ê±°
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Function   â”‚
â”‚ (ì•Œë¦¼ ë¡œì§)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ì‹¤í–‰
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     FCM      â”‚
â”‚   (ì „ì†¡)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ í•™ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Push vs Pull ë°©ì‹ì˜ ì°¨ì´ ì´í•´
- [ ] FCM ì•„í‚¤í…ì²˜ êµ¬ì¡° íŒŒì•…
- [ ] ì•Œë¦¼/ë°ì´í„° ë©”ì‹œì§€ êµ¬ë¶„
- [ ] FCM í† í° ê´€ë¦¬ ë°©ë²• ì´í•´
- [ ] ì•Œë¦¼ ìš°ì„ ìˆœìœ„ ì„¤ì • ì´í•´
- [ ] ìŠ¤ì¼€ì¤„ ì•Œë¦¼ êµ¬í˜„ ë°©ë²• íŒŒì•…

## ğŸ” ì‹¬í™” ê°œë…

### ì•Œë¦¼ ì±„ë„ (Android)
```javascript
// Android ì•Œë¦¼ ì±„ë„ ì„¤ì •
const channel = {
  id: 'health_alerts',
  name: 'ê±´ê°• ì•Œë¦¼',
  importance: 'high',
  vibration: true,
  sound: 'notification_sound.mp3'
};
```

### ì¡°ìš©í•œ ì‹œê°„ (Quiet Hours)
```javascript
function isQuietHours() {
  const hour = new Date().getHours();
  return hour >= 22 || hour < 8; // ì˜¤í›„ 10ì‹œ ~ ì˜¤ì „ 8ì‹œ
}

if (!isQuietHours() || priority === 'emergency') {
  // ì•Œë¦¼ ì „ì†¡
}
```

### ë°°ì¹˜ ì „ì†¡ ìµœì í™”
```javascript
// 500ê°œì”© ë°°ì¹˜ ì „ì†¡
async function sendBatchNotifications(tokens, message) {
  const batchSize = 500;
  const batches = [];

  for (let i = 0; i < tokens.length; i += batchSize) {
    const batch = tokens.slice(i, i + batchSize);
    batches.push(
      admin.messaging().sendMulticast({
        tokens: batch,
        ...message
      })
    );
  }

  return Promise.all(batches);
}
```

### ì‹¤íŒ¨ ì²˜ë¦¬ ë° ì¬ì‹œë„
```javascript
async function sendWithRetry(token, message, retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      return await admin.messaging().send({
        token,
        ...message
      });
    } catch (error) {
      if (error.code === 'messaging/registration-token-not-registered') {
        // í† í° ì‚­ì œ
        await removeToken(token);
        break;
      }
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
    }
  }
}
```

## ë°°í¬ ì¤€ë¹„ ì‚¬í•­

### 1. FCM ì„¤ì •
- Firebase Consoleì—ì„œ Cloud Messaging í™œì„±í™”
- ì„œë²„ í‚¤ ë° ë°œì‹ ì ID í™•ì¸
- iOSì˜ ê²½ìš° APNs ì¸ì¦ì„œ ì„¤ì •

### 2. í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
```javascript
// í´ë¼ì´ì–¸íŠ¸ í† í° íšë“
const token = await firebase.messaging().getToken();

// í† í° ê°±ì‹  ë¦¬ìŠ¤ë„ˆ
firebase.messaging().onTokenRefresh(async () => {
  const newToken = await firebase.messaging().getToken();
  // ì„œë²„ì— ìƒˆ í† í° ì—…ë°ì´íŠ¸
});
```

### 3. ê¶Œí•œ ìš”ì²­
```javascript
// ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
const permission = await Notification.requestPermission();
if (permission === 'granted') {
  // ì•Œë¦¼ í™œì„±í™”
}
```

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„
Week 8ì—ì„œëŠ” í”„ë¡œë•ì…˜ ë°°í¬ë¥¼ ìœ„í•œ ì„±ëŠ¥ ìµœì í™”, ëª¨ë‹ˆí„°ë§ ì„¤ì •, ê·¸ë¦¬ê³  ì‹¤ì œ ë°°í¬ ê³¼ì •ì„ í•™ìŠµí•©ë‹ˆë‹¤.