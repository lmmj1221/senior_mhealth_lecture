name: Deploy to GCP

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # í™˜ê²½ ì„¤ì • ë° ê²€ì¦
  setup:
    name: Setup and Validate
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      deploy-backend: ${{ steps.changes.outputs.backend }}
      deploy-frontend: ${{ steps.changes.outputs.frontend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

      - name: Detect changes
        id: changes
        run: |
          if git diff --quiet HEAD^ HEAD -- backend/; then
            echo "backend=false" >> $GITHUB_OUTPUT
          else
            echo "backend=true" >> $GITHUB_OUTPUT
          fi

          if git diff --quiet HEAD^ HEAD -- frontend/; then
            echo "frontend=false" >> $GITHUB_OUTPUT
          else
            echo "frontend=true" >> $GITHUB_OUTPUT
          fi

      - name: Run validation
        run: |
          chmod +x scripts/validate-config.sh
          # ë°°í¬ ì „ ê¸°ë³¸ ê²€ì¦ë§Œ ìˆ˜í–‰
          bash scripts/validate-config.sh || echo "âš ï¸ ì¼ë¶€ ê²€ì¦ ì‹¤íŒ¨ (ë°°í¬ëŠ” ê³„ì†ë©ë‹ˆë‹¤)"

  # Backend ë°°í¬ (Cloud Functions)
  deploy-backend:
    name: Deploy Backend Services
    needs: setup
    if: needs.setup.outputs.deploy-backend == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/functions/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Install backend dependencies
        run: |
          cd backend/functions
          npm ci

      - name: Run backend tests
        run: |
          cd backend/functions
          npm test || echo "âš ï¸ Tests skipped or failed"

      - name: Deploy Cloud Functions
        run: |
          cd backend
          firebase use ${{ secrets.GCP_PROJECT_ID }}
          firebase deploy --only functions --force --token ${{ secrets.FIREBASE_TOKEN }}
        env:
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Deploy AI Service (Cloud Run)
        if: hashFiles('backend/ai-service/**') != ''
        run: |
          cd backend/ai-service
          gcloud run deploy ai-service \
            --source . \
            --region ${{ secrets.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars GOOGLE_CLOUD_PROJECT=${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy API Service (Cloud Run)
        if: hashFiles('backend/api-service/**') != ''
        run: |
          cd backend/api-service
          gcloud run deploy api-service \
            --source . \
            --region ${{ secrets.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars GOOGLE_CLOUD_PROJECT=${{ secrets.GCP_PROJECT_ID }}

  # Frontend Web ë°°í¬ (Vercel ë˜ëŠ” Firebase Hosting)
  deploy-frontend-web:
    name: Deploy Frontend Web
    needs: setup
    if: needs.setup.outputs.deploy-frontend == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/web/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend/web
          npm ci

      - name: Create environment file
        run: |
          cd frontend/web
          cat > .env.production << EOF
          NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.FIREBASE_APP_ID }}
          NEXT_PUBLIC_API_URL=${{ secrets.API_SERVICE_URL }}
          EOF

      - name: Build
        run: |
          cd frontend/web
          npm run build

      - name: Run tests
        run: |
          cd frontend/web
          npm test || echo "âš ï¸ Tests skipped or failed"

      - name: Deploy to Vercel
        if: secrets.VERCEL_TOKEN != ''
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: frontend/web
          vercel-args: ${{ needs.setup.outputs.environment == 'production' && '--prod' || '' }}

      - name: Deploy to Firebase Hosting
        if: secrets.VERCEL_TOKEN == ''
        run: |
          npm install -g firebase-tools
          cd frontend/web
          firebase use ${{ secrets.GCP_PROJECT_ID }}
          firebase deploy --only hosting --token ${{ secrets.FIREBASE_TOKEN }}

  # ë°°í¬ ì•Œë¦¼
  notify:
    name: Deployment Notification
    needs: [setup, deploy-backend, deploy-frontend-web]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Deployed**: ${{ needs.deploy-backend.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend Deployed**: ${{ needs.deploy-frontend-web.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.deploy-backend.result }}" = "failure" ] || [ "${{ needs.deploy-frontend-web.result }}" = "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Some deployments failed. Please check the logs above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
          fi
