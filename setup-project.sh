#!/bin/bash

# í”„ë¡œì íŠ¸ ì„¤ì • ìë™í™” ìŠ¤í¬ë¦½íŠ¸
# ê° ì‚¬ìš©ìê°€ ìì‹ ì˜ í”„ë¡œì íŠ¸ IDë¡œ ì„¤ì •í•  ìˆ˜ ìˆë„ë¡ ì§€ì›

set -e

# ìƒ‰ìƒ ì½”ë“œ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}===============================================${NC}"
echo -e "${GREEN}    Senior MHealth í”„ë¡œì íŠ¸ ì„¤ì • ìŠ¤í¬ë¦½íŠ¸${NC}"
echo -e "${GREEN}===============================================${NC}"

# 1. í”„ë¡œì íŠ¸ ID ì…ë ¥ ë°›ê¸°
if [ -z "$GCP_PROJECT_ID" ]; then
    echo -e "\n${YELLOW}Google Cloud í”„ë¡œì íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:${NC}"
    read -p "Project ID: " GCP_PROJECT_ID
fi

# 2. í”„ë¡œì íŠ¸ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
echo -e "\n${YELLOW}í”„ë¡œì íŠ¸ ì •ë³´ í™•ì¸ ì¤‘...${NC}"
GCP_PROJECT_NUMBER=$(gcloud projects describe $GCP_PROJECT_ID --format="value(projectNumber)" 2>/dev/null || echo "")

if [ -z "$GCP_PROJECT_NUMBER" ]; then
    echo -e "${RED}í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ IDë¥¼ í™•ì¸í•˜ì„¸ìš”.${NC}"
    exit 1
fi

# 3. ë¦¬ì „ ì„¤ì •
DEFAULT_REGION="us-central1"
echo -e "\n${YELLOW}ë°°í¬ ë¦¬ì „ì„ ì„ íƒí•˜ì„¸ìš” (ê¸°ë³¸ê°’: $DEFAULT_REGION):${NC}"
echo "1) us-central1 (ë¯¸êµ­ ì¤‘ë¶€) - ê¶Œì¥"
echo "2) asia-northeast3 (ì„œìš¸)"
echo "3) europe-west1 (ë²¨ê¸°ì—)"
echo "4) ì§ì ‘ ì…ë ¥"
read -p "ì„ íƒ [1-4]: " region_choice

case $region_choice in
    2) GCP_REGION="asia-northeast3" ;;
    3) GCP_REGION="europe-west1" ;;
    4)
        read -p "ë¦¬ì „ ì…ë ¥: " GCP_REGION
        ;;
    *) GCP_REGION=$DEFAULT_REGION ;;
esac

# 4. .env íŒŒì¼ ìƒì„±
echo -e "\n${YELLOW}.env íŒŒì¼ ìƒì„± ì¤‘...${NC}"

cat > .env << EOF
# ====================================
# Generated by setup-project.sh
# Project: $GCP_PROJECT_ID
# Generated at: $(date)
# ====================================

# === GCP Project Configuration ===
GCP_PROJECT_ID=$GCP_PROJECT_ID
GCP_PROJECT_NUMBER=$GCP_PROJECT_NUMBER
GCP_REGION=$GCP_REGION

# === Firebase Configuration ===
FIREBASE_PROJECT_ID=$GCP_PROJECT_ID
FIREBASE_AUTH_DOMAIN=${GCP_PROJECT_ID}.firebaseapp.com
FIREBASE_STORAGE_BUCKET=${GCP_PROJECT_ID}.firebasestorage.app
FIREBASE_MESSAGING_SENDER_ID=$GCP_PROJECT_NUMBER

# === Service Names ===
SERVICE_NAME=${GCP_PROJECT_ID}-ai-service
API_SERVICE_NAME=${GCP_PROJECT_ID}-api-service

# === Storage ===
STORAGE_BUCKET=${GCP_PROJECT_ID}.appspot.com

# === Database Configuration ===
BIGQUERY_DATASET=senior_mhealth_analytics
BIGQUERY_LOCATION=$GCP_REGION

# === Environment ===
ENVIRONMENT=development
LOG_LEVEL=INFO
EOF

echo -e "${GREEN}âœ… .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"

# 5. project.config.json íŒŒì¼ ìƒì„±
echo -e "\n${YELLOW}project.config.json íŒŒì¼ ìƒì„± ì¤‘...${NC}"

cat > project.config.json << EOF
{
  "project": {
    "id": "$GCP_PROJECT_ID",
    "name": "$GCP_PROJECT_ID",
    "region": "$GCP_REGION",
    "location": "$GCP_REGION"
  },
  "firebase": {
    "projectId": "$GCP_PROJECT_ID",
    "storageBucket": "${GCP_PROJECT_ID}.firebasestorage.app",
    "messagingSenderId": "$GCP_PROJECT_NUMBER"
  },
  "cloud": {
    "projectNumber": "$GCP_PROJECT_NUMBER"
  },
  "database": {
    "cloudSqlConnectionName": "${GCP_PROJECT_ID}:${GCP_REGION}:main-instance",
    "cloudSqlInstance": "main-instance",
    "bigQueryDataset": "senior_mhealth_analytics"
  },
  "services": {
    "aiService": {
      "name": "${GCP_PROJECT_ID}-ai-service",
      "url": "https://${GCP_PROJECT_ID}-ai-service-${GCP_REGION}.run.app"
    },
    "apiService": {
      "name": "${GCP_PROJECT_ID}-api-service",
      "url": "https://${GCP_PROJECT_ID}-api-service-${GCP_REGION}.run.app"
    }
  }
}
EOF

echo -e "${GREEN}âœ… project.config.json íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"

# 5-1. .env.docker íŒŒì¼ ìƒì„± (Docker Composeìš©)
echo -e "\n${YELLOW}.env.docker íŒŒì¼ ìƒì„± ì¤‘...${NC}"

cat > .env.docker << EOF
# Docker Compose í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# Generated by setup-project.sh at $(date)

# === PostgreSQL ì„¤ì • ===
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=senior_mhealth_dev
POSTGRES_PORT=5432

# === Redis ì„¤ì • ===
REDIS_PORT=6379

# === Backend API Service ===
API_PORT=8000

# === Backend AI Service ===
AI_PORT=8001

# === Frontend Web ===
WEB_PORT=3000

# === pgAdmin ì„¤ì • ===
PGADMIN_EMAIL=admin@senior-mhealth.local
PGADMIN_PASSWORD=admin
PGADMIN_PORT=5050

# === GCP/Firebase ì„¤ì • ===
GCP_PROJECT_ID=$GCP_PROJECT_ID
FIREBASE_API_KEY=\${FIREBASE_API_KEY:-demo-api-key}

# === ê°œë°œ í™˜ê²½ ì„¤ì • ===
NODE_ENV=development
ENVIRONMENT=development
EOF

echo -e "${GREEN}âœ… .env.docker íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"

# 6. API í‚¤ ì„¤ì • ì•ˆë‚´
echo -e "\n${YELLOW}=== API í‚¤ ì„¤ì • ì•ˆë‚´ ===${NC}"
echo "ë‹¤ìŒ API í‚¤ë“¤ì„ .env íŒŒì¼ì— ì§ì ‘ ì¶”ê°€í•´ì£¼ì„¸ìš”:"
echo ""
echo "GEMINI_API_KEY=your-gemini-api-key"
echo "OPENAI_API_KEY=your-openai-api-key (ì„ íƒì‚¬í•­)"
echo "FIREBASE_API_KEY=your-firebase-api-key"
echo ""
echo "API í‚¤ ìƒì„± ë°©ë²•:"
echo "- Gemini API: https://makersuite.google.com/app/apikey"
echo "- Firebase: Firebase Console > í”„ë¡œì íŠ¸ ì„¤ì • > ì¼ë°˜"

# 7. í”„ë¡œì íŠ¸ ì„¤ì •
echo -e "\n${YELLOW}Google Cloud í”„ë¡œì íŠ¸ ì„¤ì • ì¤‘...${NC}"

# í˜„ì¬ í”„ë¡œì íŠ¸ ì„¤ì •
gcloud config set project $GCP_PROJECT_ID

# í•„ìš”í•œ API í™œì„±í™”
echo -e "\n${YELLOW}í•„ìš”í•œ API í™œì„±í™” ì¤‘...${NC}"
apis=(
    "run.googleapis.com"
    "cloudbuild.googleapis.com"
    "containerregistry.googleapis.com"
    "firestore.googleapis.com"
    "storage-component.googleapis.com"
    "bigquery.googleapis.com"
)

for api in "${apis[@]}"; do
    echo "Enabling $api..."
    gcloud services enable $api --quiet || true
done

# 8. Firebase ì´ˆê¸°í™” í™•ì¸
echo -e "\n${YELLOW}Firebase í”„ë¡œì íŠ¸ ì´ˆê¸°í™”...${NC}"
if command -v firebase &> /dev/null; then
    firebase use $GCP_PROJECT_ID || firebase use --add $GCP_PROJECT_ID
else
    echo -e "${YELLOW}Firebase CLIê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.${NC}"
    echo "ì„¤ì¹˜: npm install -g firebase-tools"
fi

# 9. ì˜ì¡´ì„± ì„¤ì¹˜ ì˜µì…˜
echo -e "\n${YELLOW}=== ì˜ì¡´ì„± ì„¤ì¹˜ ===${NC}"
read -p "ì˜ì¡´ì„±ì„ ìë™ìœ¼ë¡œ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " install_deps

if [[ "$install_deps" =~ ^[Yy]$ ]]; then
    echo -e "\n${YELLOW}Backend Functions ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...${NC}"
    if [ -d "backend/functions" ]; then
        (cd backend/functions && npm install) || echo -e "${RED}âŒ Backend functions ì„¤ì¹˜ ì‹¤íŒ¨${NC}"
    fi

 # Offer to install service account key
 echo -e "\n${YELLOW}ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì„¤ì¹˜ ì•ˆë‚´${NC}"
 read -p "ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼(.json)ì„ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¶Œì¥: ì˜ˆ) (y/N): " install_sa
 if [[ "$install_sa" =~ ^[Yy]$ ]]; then
   read -p "ì„œë¹„ìŠ¤ ê³„ì • í‚¤ íŒŒì¼ ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ~/Downloads/my-key.json): " sa_src
   sa_src=${sa_src/#\~/$HOME}
   echo -e "ì„¤ì¹˜ ì¤‘... (ëŒ€ìƒ ê²½ë¡œ: backend/service-account-key.json)"
   bash setup/scripts/install-service-account.sh "$sa_src" backend/service-account-key.json || echo -e "${RED}ì„œë¹„ìŠ¤ ê³„ì • ì„¤ì¹˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤${NC}"
   echo -e "${GREEN}ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆê±°ë‚˜ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.${NC}"
 else
   echo -e "${YELLOW}ê±´ë„ˆëœë‹ˆë‹¤. ì„¤ì¹˜ëŠ” ë‚˜ì¤‘ì— 'setup/scripts/install-service-account.sh'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.${NC}"
 fi
    echo -e "\n${YELLOW}Frontend Web ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...${NC}"
    if [ -d "frontend/web" ]; then
        (cd frontend/web && npm install) || echo -e "${RED}âŒ Frontend web ì„¤ì¹˜ ì‹¤íŒ¨${NC}"
    fi

    echo -e "\n${YELLOW}Frontend Mobile ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘...${NC}"
    if [ -d "frontend/mobile" ] && command -v flutter &> /dev/null; then
        (cd frontend/mobile && flutter pub get) || echo -e "${RED}âŒ Flutter ì„¤ì¹˜ ì‹¤íŒ¨${NC}"
    elif [ -d "frontend/mobile" ]; then
        echo -e "${YELLOW}âš ï¸ Flutter CLIê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤${NC}"
    fi

    echo -e "${GREEN}âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ${NC}"
else
    echo -e "${YELLOW}â­ï¸  ì˜ì¡´ì„± ì„¤ì¹˜ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤${NC}"
fi

# 10. ì„¤ì • ê²€ì¦
echo -e "\n${YELLOW}=== ì„¤ì • ê²€ì¦ ===${NC}"
if [ -f "scripts/validate-config.sh" ]; then
    echo "ì„¤ì • ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘..."
    bash scripts/validate-config.sh || echo -e "${YELLOW}âš ï¸ ì¼ë¶€ ê²€ì¦ ì‹¤íŒ¨ (ê°œë°œì€ ê³„ì† ê°€ëŠ¥í•©ë‹ˆë‹¤)${NC}"
else
    echo -e "${YELLOW}âš ï¸ validate-config.shë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤${NC}"
fi

# 11. ì™„ë£Œ
echo -e "\n${GREEN}===============================================${NC}"
echo -e "${GREEN}âœ… í”„ë¡œì íŠ¸ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
echo -e "${GREEN}===============================================${NC}"
echo ""
echo "ğŸ“‹ ìƒì„±ëœ íŒŒì¼:"
echo "  âœ“ .env                    - í™˜ê²½ ë³€ìˆ˜"
echo "  âœ“ project.config.json    - í”„ë¡œì íŠ¸ ì„¤ì •"
echo "  âœ“ .env.docker            - Docker Compose ì„¤ì •"
echo ""
echo "ğŸ“Š í”„ë¡œì íŠ¸ ì •ë³´:"
echo "  â€¢ í”„ë¡œì íŠ¸ ID: $GCP_PROJECT_ID"
echo "  â€¢ í”„ë¡œì íŠ¸ ë²ˆí˜¸: $GCP_PROJECT_NUMBER"
echo "  â€¢ ë¦¬ì „: $GCP_REGION"
echo ""
echo "ğŸ“ ë‹¤ìŒ ë‹¨ê³„:"
echo ""
echo "  1ï¸âƒ£  API í‚¤ ì¶”ê°€ (í•„ìˆ˜)"
echo "     .env íŒŒì¼ì„ ì—´ì–´ ë‹¤ìŒ í‚¤ë“¤ì„ ì¶”ê°€í•˜ì„¸ìš”:"
echo "     - GEMINI_API_KEY=your-key"
echo "     - FIREBASE_API_KEY=your-key"
echo ""
if [[ ! "$install_deps" =~ ^[Yy]$ ]]; then
echo "  2ï¸âƒ£  ì˜ì¡´ì„± ì„¤ì¹˜"
echo "     cd backend/functions && npm install"
echo "     cd frontend/web && npm install"
echo "     cd frontend/mobile && flutter pub get"
echo ""
fi
echo "  3ï¸âƒ£  ë¡œì»¬ ê°œë°œ í™˜ê²½ ì‹œì‘"
echo "     ğŸ³ Docker ì‚¬ìš© (ê¶Œì¥):"
echo "        docker-compose up -d"
echo "        docker-compose logs -f"
echo ""
echo "     ë˜ëŠ” ì§ì ‘ ì‹¤í–‰:"
echo "        firebase emulators:start        # Firebase ì—ë®¬ë ˆì´í„°"
echo "        cd frontend/web && npm run dev  # í”„ë¡ íŠ¸ì—”ë“œ"
echo ""
echo "  4ï¸âƒ£  VSCode ì„¤ì • (ê¶Œì¥)"
echo "     VSCodeë¥¼ ì—´ë©´ ê¶Œì¥ í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ ì•Œë¦¼ì´ í‘œì‹œë©ë‹ˆë‹¤"
echo "     .vscode/extensions.jsonì— í•„ìš”í•œ í™•ì¥ ëª©ë¡ì´ ìˆìŠµë‹ˆë‹¤"
echo ""
echo "  5ï¸âƒ£  CI/CD ì„¤ì • (GitHub ì‚¬ìš© ì‹œ)"
echo "     GitHub ì €ì¥ì†Œ Settings > Secrets and variables > Actionsì—ì„œ"
echo "     ë‹¤ìŒ Secretsë¥¼ ì¶”ê°€í•˜ì„¸ìš”:"
echo ""
echo "     í•„ìˆ˜ Secrets:"
echo "     â€¢ GCP_PROJECT_ID=$GCP_PROJECT_ID"
echo "     â€¢ GCP_REGION=$GCP_REGION"
echo "     â€¢ GCP_SA_KEY=<ì„œë¹„ìŠ¤ ê³„ì • í‚¤ JSON>"
echo "     â€¢ FIREBASE_TOKEN=<firebase login:ci ê²°ê³¼>"
echo "     â€¢ FIREBASE_PROJECT_ID=$GCP_PROJECT_ID"
echo "     â€¢ FIREBASE_API_KEY=<Firebase API í‚¤>"
echo ""
echo "     ì„ íƒ Secrets (Vercel ë°°í¬ ì‹œ):"
echo "     â€¢ VERCEL_TOKEN=<Vercel í† í°>"
echo "     â€¢ VERCEL_ORG_ID=<Vercel ì¡°ì§ ID>"
echo "     â€¢ VERCEL_PROJECT_ID=<Vercel í”„ë¡œì íŠ¸ ID>"
echo ""
echo "     GitHub Actions ì›Œí¬í”Œë¡œìš°:"
echo "     â€¢ .github/workflows/validate-config.yml - ì„¤ì • ê²€ì¦"
echo "     â€¢ .github/workflows/deploy.yml          - ìë™ ë°°í¬"
echo "     â€¢ .github/workflows/pr-checks.yml       - PR ì²´í¬"
echo ""
echo "  6ï¸âƒ£  ë°°í¬"
echo "     firebase deploy                             # Functions + Hosting"
echo "     cd backend/api-service && gcloud run deploy # API Service"
echo "     cd backend/ai-service && gcloud run deploy  # AI Service"
echo ""
echo "ğŸ“š ìì„¸í•œ ë¬¸ì„œ:"
echo "  â€¢ README.md           - í”„ë¡œì íŠ¸ ê°œìš” ë° ì‹œì‘ ê°€ì´ë“œ"
echo "  â€¢ SETUP_GUIDE.md      - ìƒì„¸ ì„¤ì • ê°€ì´ë“œ"
echo "  â€¢ DOCKER_SETUP.md     - Docker í™˜ê²½ ê°€ì´ë“œ"
echo "  â€¢ docs/               - ì¶”ê°€ ë¬¸ì„œ"
echo ""
echo "ğŸ”— ìœ ìš©í•œ ëª…ë ¹ì–´:"
echo "  â€¢ bash scripts/validate-config.sh  - ì„¤ì • ê²€ì¦"
echo "  â€¢ docker-compose up -d             - ì „ì²´ ìŠ¤íƒ ì‹œì‘"
echo "  â€¢ docker-compose logs -f           - ë¡œê·¸ í™•ì¸"
echo "  â€¢ firebase emulators:start         - Firebase ì—ë®¬ë ˆì´í„°"
echo ""
echo -e "${GREEN}ğŸ‰ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì¦ê±°ìš´ ê°œë°œ ë˜ì„¸ìš”!${NC}"
